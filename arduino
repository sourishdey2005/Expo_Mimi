#include "HX711.h"
#include <WiFi.h>
#include <HTTPClient.h>

#define DT 4
#define SCK 5

#define GREEN_LED 18
#define YELLOW_LED 19
#define RED_LED 21

HX711 scale;

const char* ssid = "motog545G_5119";
const char* password = "satarupa1981";
const char* serverName = "http://10.33.181.98:8000/update";


float calibration_factor = -7050;

void setup() {
  Serial.begin(115200);

  pinMode(GREEN_LED, OUTPUT);
  pinMode(YELLOW_LED, OUTPUT);
  pinMode(RED_LED, OUTPUT);

  scale.begin(DT, SCK);
  scale.set_scale(calibration_factor);
  scale.tare();

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("Connected to WiFi");
}

void loop() {

  float weight = scale.get_units(10);
  Serial.print("Weight: ");
  Serial.println(weight);

  String status;

  if (weight < 200) {
    status = "FREE";
    digitalWrite(GREEN_LED, HIGH);
    digitalWrite(YELLOW_LED, LOW);
    digitalWrite(RED_LED, LOW);
  }
  else if (weight < 2000) {
    status = "PARTIAL";
    digitalWrite(GREEN_LED, LOW);
    digitalWrite(YELLOW_LED, HIGH);
    digitalWrite(RED_LED, LOW);
  }
  else {
    status = "OCCUPIED";
    digitalWrite(GREEN_LED, LOW);
    digitalWrite(YELLOW_LED, LOW);
    digitalWrite(RED_LED, HIGH);
  }

  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(serverName);
    http.addHeader("Content-Type", "application/json");

    String jsonData = "{\"seat_id\":1,\"status\":\"" + status + "\"}";
    http.POST(jsonData);
    http.end();
  }

  delay(3000);
}
